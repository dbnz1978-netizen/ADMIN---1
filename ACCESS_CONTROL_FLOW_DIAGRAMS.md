# Блок-схема работы системы контроля доступа

## Схема проверки доступа при запросе страницы плагина

```
┌──────────────────────────────────────────────────────────┐
│ Пользователь запрашивает страницу плагина                │
│ (например: /plugins/news-plugin/pages/articles/list.php) │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│ pluginAccessGuard($pdo, 'news-plugin')                   │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │ Проверка авторизации  │
         │ requireAuth($pdo)     │
         └───────┬───────────────┘
                 │
         ┌───────▼────────┐
         │ Авторизован?   │
         └───┬────────┬───┘
             │        │
         НЕТ │        │ ДА
             │        │
             ▼        ▼
      ┌──────────┐   ┌─────────────────────────┐
      │ HTTP 403 │   │ Получить данные         │
      │ Выход    │   │ getUserData($pdo)       │
      └──────────┘   └──────┬──────────────────┘
                            │
                            ▼
                  ┌─────────────────────┐
                  │ Определить роль     │
                  │ $role = author      │
                  │ ('user' / 'admin')  │
                  └──────┬──────────────┘
                         │
                         ▼
         ┌───────────────────────────────────┐
         │ Если указана $requiredRole?       │
         │ (например, 'admin')               │
         └───────┬───────────────┬───────────┘
                 │               │
             ДА  │               │ НЕТ
                 │               │
                 ▼               │
      ┌──────────────────┐       │
      │ $role == required?│      │
      └───┬──────────┬───┘       │
          │          │            │
      НЕТ │          │ ДА         │
          │          │            │
          ▼          │            │
   ┌──────────┐     └────────────┼──────┐
   │ HTTP 403 │                  │      │
   │ Выход    │                  │      │
   └──────────┘                  │      │
                                 ▼      ▼
                  ┌───────────────────────────────────┐
                  │ Получить настройки доступа        │
                  │ getPluginAccessSettings($pdo)     │
                  └────────────┬──────────────────────┘
                               │
                               ▼
                  ┌────────────────────────────────┐
                  │ hasPluginAccess('news', $role)?│
                  └──────┬────────────┬────────────┘
                         │            │
                     НЕТ │            │ ДА
                         │            │
                         ▼            ▼
                  ┌──────────┐   ┌─────────────┐
                  │ HTTP 403 │   │ Доступ      │
                  │ Логирование│   │ разрешён    │
                  │ Выход    │   │ Возврат     │
                  └──────────┘   │ $userDataAdmin │
                                 └─────────────┘
```

## Схема фильтрации меню в сайдбаре

```
┌──────────────────────────────────────┐
│ Загрузка sidebar.php                 │
└────────────┬─────────────────────────┘
             │
             ▼
┌──────────────────────────────────────┐
│ getPluginMenus($pdo)                 │
│ Получить все включённые плагины      │
└────────────┬─────────────────────────┘
             │
             ▼
┌──────────────────────────────────────┐
│ filterPluginMenusByAccess(           │
│   $pdo, $menus, $userRole            │
│ )                                    │
└────────────┬─────────────────────────┘
             │
             ▼
      ┌──────────────┐
      │ Для каждого  │
      │ плагина      │
      └──────┬───────┘
             │
             ▼
    ┌────────────────────────┐
    │ hasPluginAccess(       │
    │   $pluginName, $role   │
    │ )?                     │
    └──┬─────────────────┬───┘
       │                 │
   НЕТ │                 │ ДА
       │                 │
       ▼                 ▼
  ┌─────────┐      ┌──────────┐
  │ Скрыть  │      │ Показать │
  │ меню    │      │ меню     │
  └─────────┘      └──────────┘
```

## Схема сохранения настроек

```
┌──────────────────────────────────────┐
│ Администратор открывает              │
│ /plugins/news-plugin/pages/          │
│ settings/access.php                  │
└────────────┬─────────────────────────┘
             │
             ▼
┌──────────────────────────────────────┐
│ Проверка: author == 'admin'?         │
└────┬────────────────────────┬────────┘
     │                        │
 НЕТ │                        │ ДА
     │                        │
     ▼                        ▼
┌─────────┐      ┌─────────────────────┐
│ HTTP 403│      │ Показать форму      │
└─────────┘      │ с переключателями:  │
                 │ □ user              │
                 │ □ admin             │
                 └──────┬──────────────┘
                        │
                        │ POST
                        ▼
                ┌────────────────────┐
                │ Проверка CSRF      │
                └──┬──────────────┬──┘
                   │              │
               НЕТ │              │ ДА
                   │              │
                   ▼              ▼
            ┌─────────┐   ┌──────────────────┐
            │ Ошибка  │   │ Получить значения│
            │ 403     │   │ чекбоксов        │
            └─────────┘   └────┬─────────────┘
                               │
                               ▼
                  ┌─────────────────────────┐
                  │ Обновить структуру:     │
                  │ plugins_access.news-plugin = { │
                  │   user: true/false      │
                  │   admin: true/false     │
                  │ }                       │
                  └──────┬──────────────────┘
                         │
                         ▼
                  ┌──────────────────────┐
                  │ savePluginAccess     │
                  │ Settings($pdo)       │
                  └──────┬───────────────┘
                         │
                         ▼
                  ┌──────────────────────┐
                  │ Сохранить в users.data│
                  │ администратора        │
                  │ (JSON)                │
                  └──────┬───────────────┘
                         │
                         ▼
                  ┌──────────────────────┐
                  │ Логирование          │
                  │ Flash-сообщение      │
                  │ Редирект             │
                  └──────────────────────┘
```

## Формат данных в БД

```
Таблица: users
┌──────┬──────────┬──────────────────────────────┐
│ id   │ author   │ data (JSON)                  │
├──────┼──────────┼──────────────────────────────┤
│ 1    │ admin    │ {                            │
│      │          │   "plugins_access": {        │
│      │          │     "news": {                │
│      │          │       "user": true,          │
│      │          │       "admin": true          │
│      │          │     }                        │
│      │          │   },                         │
│      │          │   ... другие настройки       │
│      │          │ }                            │
└──────┴──────────┴──────────────────────────────┘
```

## Логика принятия решений

```
hasPluginAccess($pluginName, $userRole):

1. Получить $accessSettings из users.data администратора
2. Если $accessSettings === false:
   └─> return false (ошибка БД)

3. Если НЕТ настроек для $pluginName:
   └─> return true (по умолчанию разрешено)

4. Проверить $accessSettings[$pluginName][$userRole]:
   └─> return значение ?? true (если не задано - разрешено)
```

## Приоритеты безопасности

1. **Авторизация** - первая проверка
2. **Валидация пользователя** - проверка в БД
3. **Проверка роли** - для admin-only страниц
4. **Проверка настроек доступа** - финальная проверка
5. **Логирование** - все события доступа

## Точки входа для разработчиков

### Для плагинов
```php
// В начале каждой страницы плагина
require_once __DIR__ . '/path/to/plugin_access.php';
$userDataAdmin = pluginAccessGuard($pdo, 'plugin-name');
```

### Для admin-only страниц
```php
$userDataAdmin = pluginAccessGuard($pdo, 'plugin-name', 'admin');
```

### Для проверки вручную
```php
if (hasPluginAccess($pdo, 'plugin-name', $userRole)) {
    // Показать кнопку или функционал
}
```

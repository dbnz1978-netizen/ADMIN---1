# Плагин резервного копирования - Руководство по тестированию

## Описание

Плагин для создания резервной копии сайта с возможностью выбора таблиц базы данных и папок для архивации. Включает в себя PHP-установщик с Bootstrap интерфейсом для восстановления сайта на новом хостинге.

## Предварительные требования

1. База данных должна быть настроена
2. В БД должен быть пользователь с `author='admin'`
3. PHP должен иметь следующие расширения:
   - PDO
   - ZIP
   - MySQL
4. Директория `../backups` должна существовать и иметь права на запись

## Установка плагина

### Шаг 1: Проверка файлов

Убедитесь, что следующие файлы присутствуют:

```
/plugins/backup-plugin/plugin.json
/plugins/backup-plugin/nav-config.json
/plugins/backup-plugin/install.php
/plugins/backup-plugin/uninstall.php
/plugins/backup-plugin/pages/backup.php
/plugins/backup-plugin/functions/backup_functions.php
../backups/.gitkeep
```

### Шаг 2: Установка через админ-панель

1. Войти под администратором (author='admin')
2. Открыть `/admin/plugins/list.php`
3. Найти плагин "Система резервного копирования" в списке
4. Нажать кнопку "Установить"
5. Убедиться, что появилось сообщение об успешной установке
6. Включить плагин, если он не включен автоматически

### Шаг 3: Проверка меню

1. В боковом меню должен появиться раздел "Резервное копирование" с иконкой архива
2. В подменю должен быть пункт "Создать резервную копию"

## Тестовые сценарии

### Тест 1: Отображение списка таблиц и папок

**Цель:** Проверить корректное отображение интерфейса

**Шаги:**
1. Открыть `/plugins/backup-plugin/pages/backup.php`
2. Проверить, что отображается список всех таблиц БД
3. Проверить, что все таблицы отмечены чекбоксами по умолчанию
4. Проверить, что отображается список папок в корне сайта
5. Проверить, что папка `admin` не отображается в списке (она добавляется автоматически)
6. Проверить, что все папки отмечены чекбоксами по умолчанию

**Ожидаемый результат:**
- ✓ Все таблицы БД отображаются с чекбоксами
- ✓ Все папки (кроме admin) отображаются с чекбоксами
- ✓ Все чекбоксы включены по умолчанию
- ✓ Присутствует информационное сообщение о автоматическом включении папки admin
- ✓ Присутствует кнопка "Создать резервную копию"

### Тест 2: Функционал выбора всех элементов

**Цель:** Проверить работу чекбоксов "Выбрать все"

**Шаги:**
1. Открыть страницу создания резервной копии
2. Снять чекбокс "Выбрать все таблицы"
3. Проверить, что все таблицы снялись
4. Снова поставить чекбокс "Выбрать все таблицы"
5. Проверить, что все таблицы отмечены
6. Повторить для папок

**Ожидаемый результат:**
- ✓ Чекбокс "Выбрать все таблицы" управляет всеми таблицами
- ✓ Чекбокс "Выбрать все папки" управляет всеми папками
- ✓ При снятии/установке одного элемента, чекбокс "Выбрать все" синхронизируется

### Тест 3: Создание резервной копии с выбором всех элементов

**Цель:** Проверить создание полной резервной копии

**Шаги:**
1. Открыть страницу создания резервной копии
2. Убедиться, что все таблицы и папки выбраны
3. Нажать кнопку "Создать резервную копию"
4. Дождаться завершения операции

**Ожидаемый результат:**
- ✓ Появляется сообщение об успешном создании резервной копии
- ✓ Появляется кнопка "Скачать архив"
- ✓ В директории `../backups` создается ZIP файл с именем вида `backup_YYYY-MM-DD_HH-ii-ss.zip`
- ✓ Размер архива соответствует размеру выбранных файлов и БД

### Тест 4: Создание резервной копии с выбором отдельных элементов

**Цель:** Проверить создание частичной резервной копии

**Шаги:**
1. Открыть страницу создания резервной копии
2. Снять чекбокс "Выбрать все таблицы"
3. Выбрать только 2-3 таблицы (например, `users`, `plugins`)
4. Снять чекбокс "Выбрать все папки"
5. Выбрать только 1-2 папки (например, `connect`, `plugins`)
6. Нажать кнопку "Создать резервную копию"
7. Дождаться завершения операции

**Ожидаемый результат:**
- ✓ Резервная копия создается успешно
- ✓ В архиве присутствуют только выбранные таблицы
- ✓ В архиве присутствуют только выбранные папки + admin (автоматически)
- ✓ Размер архива меньше, чем в Тесте 3

### Тест 5: Проверка содержимого архива

**Цель:** Проверить корректность структуры архива

**Шаги:**
1. Создать резервную копию (любым способом из предыдущих тестов)
2. Скачать созданный архив
3. Распаковать архив в тестовую директорию
4. Проверить содержимое архива

**Ожидаемый результат:**
- ✓ Архив содержит файл `database.sql`
- ✓ Архив содержит файл `install.php`
- ✓ Архив содержит файл `README.txt`
- ✓ Архив содержит директорию `files/` с выбранными папками
- ✓ Файл `database.sql` содержит SQL-дампы выбранных таблиц
- ✓ Файл `install.php` является валидным PHP-кодом
- ✓ Файл `README.txt` содержит инструкции по установке

### Тест 6: Проверка SQL дампа

**Цель:** Проверить корректность экспорта базы данных

**Шаги:**
1. Создать резервную копию
2. Извлечь файл `database.sql` из архива
3. Открыть файл в текстовом редакторе
4. Проверить структуру SQL

**Ожидаемый результат:**
- ✓ Файл содержит заголовок с датой создания
- ✓ Для каждой таблицы есть `DROP TABLE IF EXISTS`
- ✓ Для каждой таблицы есть `CREATE TABLE`
- ✓ Для каждой таблицы есть `INSERT` запросы с данными
- ✓ SQL синтаксис корректен (можно проверить phpMyAdmin)

### Тест 7: Проверка установщика (визуально)

**Цель:** Проверить интерфейс установщика

**Шаги:**
1. Создать резервную копию
2. Извлечь файл `install.php` из архива
3. Открыть файл в браузере (можно локально через PHP сервер)
4. Проверить внешний вид и функциональность формы

**Ожидаемый результат:**
- ✓ Установщик использует Bootstrap стили
- ✓ Форма содержит поля для ввода:
  - Хост базы данных (по умолчанию "localhost")
  - Имя базы данных
  - Пользователь базы данных
  - Пароль базы данных
- ✓ Присутствует кнопка "Установить сайт"
- ✓ Интерфейс адаптивен (корректно отображается на мобильных устройствах)

### Тест 8: Обработка ошибок

**Цель:** Проверить обработку ошибочных ситуаций

**Шаги для подтеста 8.1 (нет выбранных таблиц):
1. Открыть страницу создания резервной копии
2. Снять все чекбоксы с таблиц
3. Нажать кнопку "Создать резервную копию"

**Ожидаемый результат 8.1:**
- ✓ Создается резервная копия с пустым database.sql (или с минимальной структурой)

**Шаги для подтеста 8.2 (нет прав на запись):
1. Временно изменить права на директорию `../backups` (chmod 555)
2. Попытаться создать резервную копию
3. Вернуть права обратно (chmod 755)

**Ожидаемый результат 8.2:**
- ✓ Появляется сообщение об ошибке
- ✓ Ошибка указывает на проблему с правами доступа

### Тест 9: Управление доступом и видимость меню

**Цель:** Проверить работу системы управления доступом и видимость меню для разных ролей

**Предварительные требования:**
- Создать тестового пользователя с ролью 'user' (author='user')

**Шаги для подтеста 9.1 (отключение доступа для пользователей):
1. Войти под администратором (author='admin')
2. Открыть `/plugins/backup-plugin/pages/settings/access.php`
3. Снять чекбокс "Разрешить доступ пользователям"
4. Нажать кнопку "Сохранить настройки"
5. Выйти из системы
6. Войти под тестовым пользователем (author='user')
7. Проверить боковое меню

**Ожидаемый результат 9.1:**
- ✓ В боковом меню НЕ отображается раздел "Резервное копирование"
- ✓ При попытке прямого доступа к `/plugins/backup-plugin/pages/backup.php` происходит перенаправление на logout.php

**Шаги для подтеста 9.2 (включение доступа для пользователей):
1. Войти под администратором (author='admin')
2. Открыть `/plugins/backup-plugin/pages/settings/access.php`
3. Установить чекбокс "Разрешить доступ пользователям"
4. Нажать кнопку "Сохранить настройки"
5. Выйти из системы
6. Войти под тестовым пользователем (author='user')
7. Проверить боковое меню
8. Перейти в раздел "Резервное копирование"

**Ожидаемый результат 9.2:**
- ✓ В боковом меню отображается раздел "Резервное копирование"
- ✓ Пользователь может открыть страницу создания резервной копии
- ✓ Пользователь может создать резервную копию
- ✓ Кнопки "Скачать" и "Удалить" для существующих резервных копий НЕ отображаются (вместо них текст "Только для администраторов")
- ✓ При попытке прямого доступа к download_backup.php или delete_backup.php происходит перенаправление на logout.php

**Шаги для подтеста 9.3 (проверка доступа администратора):
1. Войти под администратором (author='admin')
2. Проверить боковое меню
3. Перейти в раздел "Резервное копирование"

**Ожидаемый результат 9.3:**
- ✓ Раздел "Резервное копирование" всегда отображается для администратора независимо от настроек доступа
- ✓ Администратор может создавать резервные копии
- ✓ Администратор видит кнопки "Скачать" и "Удалить" для всех резервных копий
- ✓ Все операции (создание, скачивание, удаление) работают корректно

### Тест 10: Удаление плагина

**Цель:** Проверить корректное удаление плагина

**Шаги:**
1. Открыть `/admin/plugins/list.php`
2. Найти плагин "Система резервного копирования"
3. Нажать кнопку "Удалить"
4. В модальном окне выбрать "Удалить файлы плагина с диска"
5. Подтвердить удаление

**Ожидаемый результат:**
- ✓ Плагин успешно удален из списка
- ✓ Директория `/plugins/backup-plugin` удалена
- ✓ Меню "Резервное копирование" исчезло из сайдбара
- ✓ Созданные резервные копии остаются в `../backups`

## Проверка безопасности

### Безопасность 1: CSRF защита

**Проверка:**
- Форма создания резервной копии содержит CSRF токен
- Попытка отправить форму без токена или с неверным токеном должна быть отклонена

### Безопасность 2: Авторизация и управление доступом

**Проверка:**
- Доступ к странице плагина без авторизации должен перенаправлять на logout.php
- Доступ к странице плагина зависит от настроек доступа:
  - Если доступ для роли 'user' отключен в настройках (`/plugins/backup-plugin/pages/settings/access.php`), пользователи с ролью 'user' должны быть перенаправлены на logout.php
  - Если доступ для роли 'user' включен, пользователи с ролью 'user' должны иметь доступ к странице создания резервных копий
  - Администраторы (author='admin') всегда имеют доступ к плагину
- Страницы download_backup.php и delete_backup.php доступны только администраторам независимо от настроек доступа
- Кнопки скачивания и удаления резервных копий скрыты для пользователей с ролью 'user'

### Безопасность 3: SQL инъекции

**Проверка:**
- Все параметры, используемые в SQL запросах, должны быть экранированы через PDO prepared statements
- В файле backup_functions.php используется $pdo->quote() для экранирования значений

### Безопасность 4: Path traversal

**Проверка:**
- Названия папок и таблиц проверяются перед использованием
- Использование realpath() для нормализации путей

## Известные ограничения

1. **Размер архива**: Максимальный размер архива ограничен:
   - PHP memory_limit
   - PHP max_execution_time
   - Размером диска

2. **Расширение ZIP**: Требуется установленное расширение PHP ZIP

3. **Права доступа**: Требуются права на запись в директорию `../backups`

4. **Символические ссылки**: Символические ссылки не обрабатываются корректно при копировании

## Рекомендации по улучшению

1. Добавить поддержку больших баз данных (chunk-based экспорт)
2. Добавить планировщик для автоматических резервных копий
3. Добавить возможность хранения резервных копий на внешних хранилищах (S3, FTP)
4. Добавить шифрование архивов
5. Добавить возможность восстановления резервной копии через админ-панель
6. Добавить журнал истории резервных копий
7. Добавить возможность удаления старых резервных копий

## Заключение

После прохождения всех тестов плагин готов к использованию в продакшене. Убедитесь, что регулярно создаются резервные копии и они хранятся в безопасном месте (желательно на другом сервере или в облаке).

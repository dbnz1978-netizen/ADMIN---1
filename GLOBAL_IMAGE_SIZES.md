# Global Image Sizes Settings

## Обзор

Система глобальных настроек размеров изображений позволяет централизованно управлять параметрами генерации изображений для всех блоков загрузки файлов в админ-панели.

## Архитектура

### Основные компоненты

1. **Модуль функций** (`/admin/functions/image_sizes.php`)
   - `getDefaultImageSizes()` - возвращает настройки по умолчанию
   - `getGlobalImageSizes($pdo)` - читает настройки из БД или возвращает defaults
   - `validateImageSizes($sizes)` - валидирует структуру настроек
   - `validateImageSizesFromPost($postData)` - валидирует данные из формы
   - `validateDimension($dimension)` - валидирует одну размерность

2. **UI для настроек** (`/admin/user/user_settings.php`)
   - Форма редактирования настроек размеров
   - Валидация на стороне сервера
   - Сохранение в JSON-данных администратора

3. **Применение настроек**
   - Все страницы с загрузкой изображений используют `getGlobalImageSizes($pdo)`
   - Обработчик загрузки (`upload-handler.php`) использует глобальные настройки как fallback

## Настройки размеров

Система поддерживает 4 размера изображений:

### Thumbnail (миниатюра)
- **Назначение**: Превью изображений в списках и галереях
- **Требования**: Оба параметра (ширина и высота) должны быть числами
- **По умолчанию**: 100x100 px, режим "cover"

### Small (маленький)
- **Назначение**: Маленькие изображения для карточек
- **По умолчанию**: 300px ширина, высота "auto", режим "contain"

### Medium (средний)
- **Назначение**: Изображения среднего размера для контента
- **По умолчанию**: 600px ширина, высота "auto", режим "contain"

### Large (большой)
- **Назначение**: Полноразмерные изображения
- **По умолчанию**: 1200px ширина, высота "auto", режим "contain"

## Режимы обработки изображений

### Cover (обрезка)
- Изображение масштабируется с сохранением пропорций для полного заполнения заданного размера
- Части изображения могут быть обрезаны
- Используется для thumbnail, где важен точный размер

### Contain (вписывание)
- Изображение масштабируется с сохранением пропорций для вписывания в заданный размер
- Изображение полностью видимо, может быть меньше целевого размера
- Используется для small/medium/large, где важны пропорции

## Формат данных

### В базе данных
Настройки хранятся в JSON-поле `data` таблицы `users` для пользователя с `author='admin'`:

```json
{
  "global_image_sizes": {
    "thumbnail": [100, 100, "cover"],
    "small": [300, "auto", "contain"],
    "medium": [600, "auto", "contain"],
    "large": [1200, "auto", "contain"]
  }
}
```

### В PHP-коде
```php
$imageSizes = [
    "thumbnail" => [100, 100, "cover"],
    "small"     => [300, 'auto', "contain"],
    "medium"    => [600, 'auto', "contain"],
    "large"     => [1200, 'auto', "contain"]
];
```

Формат: `[ширина, высота, режим]`

## Использование

### Получение настроек в коде

```php
// Подключить модуль через init.php
$config = [
    'image_sizes' => true,
    // ... другие настройки
];
require_once __DIR__ . '/../functions/init.php';

// Получить глобальные настройки
$imageSizes = getGlobalImageSizes($pdo);

// Установить в сессию для JS-модуля
$_SESSION["imageSizes_{$sectionId}"] = $imageSizes;
```

### Редактирование настроек

1. Открыть страницу настроек: `/admin/user/user_settings.php`
2. Найти раздел "Глобальные настройки размеров изображений"
3. Изменить параметры для нужных размеров
4. Сохранить форму

Настройки автоматически применятся ко всем блокам загрузки:
- Личные данные пользователя (аватар, дополнительные изображения)
- Библиотека файлов
- Настройки админ-панели (логотип)
- Добавление пользователей
- Плагин новостей (категории, статьи, дополнительный контент)

## Валидация

### Правила валидации

1. **Режим**: только 'cover' или 'contain'
2. **Размерность**: положительное целое число или 'auto'
3. **Thumbnail**: обе размерности должны быть числами (не 'auto')
4. **Структура**: все 4 размера обязательны

### Примеры валидации

**✅ Корректно:**
```php
$sizes = [
    'thumbnail' => [150, 150, 'cover'],
    'small' => [400, 'auto', 'contain'],
    'medium' => [800, 'auto', 'contain'],
    'large' => [1600, 'auto', 'contain']
];
```

**❌ Некорректно:**
```php
// Thumbnail с 'auto'
$sizes = [
    'thumbnail' => ['auto', 150, 'cover'], // ОШИБКА!
    // ...
];

// Неверный режим
$sizes = [
    'thumbnail' => [150, 150, 'stretch'], // ОШИБКА!
    // ...
];

// Отрицательный размер
$sizes = [
    'thumbnail' => [-100, 150, 'cover'], // ОШИБКА!
    // ...
];
```

## Fallback механизм

Если настройки не заданы или некорректны, система автоматически использует значения по умолчанию:

1. При чтении из БД (`getGlobalImageSizes`)
   - Если `global_image_sizes` отсутствует → defaults
   - Если настройки некорректны → defaults
   - При ошибке БД → defaults

2. При загрузке файла (`upload-handler.php`)
   - Если в сессии нет настроек → `getGlobalImageSizes($pdo)`
   - Это обеспечивает применение глобальных настроек

## Интеграция с существующим кодом

### До внедрения
```php
// Дублирование в каждом файле
$imageSizes = [
    "thumbnail" => [100, 100, "cover"],
    "small"     => [300, 'auto', "contain"],
    "medium"    => [600, 'auto', "contain"],
    "large"     => [1200, 'auto', "contain"]
];
$_SESSION["imageSizes_{$sectionId}"] = $imageSizes;
```

### После внедрения
```php
// Единый источник настроек
$imageSizes = getGlobalImageSizes($pdo);
$_SESSION["imageSizes_{$sectionId}"] = $imageSizes;
```

## Безопасность

1. **Валидация**: Все данные из формы валидируются
2. **CSRF-защита**: Форма защищена CSRF-токеном
3. **Права доступа**: Только администраторы могут изменять настройки
4. **Санитизация**: Все входные данные проверяются и нормализуются

## Расширение

Для добавления нового размера:

1. Обновить `getDefaultImageSizes()` в `image_sizes.php`
2. Добавить в валидацию в `validateImageSizes()`
3. Добавить в `$requiredSizes` массив
4. Добавить поля в форму `user_settings.php`
5. Добавить обработку в `validateImageSizesFromPost()`

## Тестирование

Модуль протестирован на:
- Корректность валидации
- Fallback механизм
- Сохранение и чтение из БД
- Обработка некорректных данных
- Интеграция со всеми страницами загрузки

См. тесты в:
- `/tmp/test_image_sizes.php` - Unit тесты
- `/tmp/test_integration.php` - Интеграционные тесты

## Версия

- **Версия**: 1.0
- **Дата**: 2026-02-11
- **Автор**: Команда разработки

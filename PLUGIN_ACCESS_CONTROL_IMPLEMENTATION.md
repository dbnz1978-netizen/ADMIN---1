# Реализация механизма ограничения доступа к плагинам

## Обзор

Реализован единый механизм управления доступом к разделам плагинов админ-панели по роли пользователя (поле `users.author`).

## Реализованные компоненты

### 1. Централизованная система управления доступом

**Файл:** `/admin/functions/plugin_access.php`

Ключевые функции:

- `getPluginAccessSettings($pdo)` - Получает настройки доступа из JSON-поля администратора
- `savePluginAccessSettings($pdo, $accessSettings)` - Сохраняет настройки доступа
- `hasPluginAccess($pdo, $pluginName, $userRole)` - Проверяет наличие доступа у роли
- `pluginAccessGuard($pdo, $pluginName, $requiredRole = null)` - Guard-функция для защиты страниц
- `filterPluginMenusByAccess($pdo, $pluginMenus, $userRole)` - Фильтрует меню по правам

### 2. Страница настроек доступа

**Файл:** `/plugins/news-plugin/pages/settings/access.php`

Функционал:
- UI с двумя переключателями (user/admin)
- POST-обработчик с CSRF-защитой
- Сохранение в `users.data` администратора
- Доступ только для роли 'admin'

### 3. Обновленная навигация плагина

**Файл:** `/plugins/news-plugin/nav-config.json`

Добавлен пункт меню "Настройки" с иконкой шестеренки.

### 4. Защита страниц плагина

Обновлены все страницы плагина новостей:
- `pages/articles/article_list.php`
- `pages/articles/add_article.php`
- `pages/articles/add_extra.php`
- `pages/articles/extra_list.php`
- `pages/categories/category_list.php`
- `pages/categories/add_category.php`
- `pages/settings/access.php` (admin-only)

Во всех страницах добавлен вызов `pluginAccessGuard($pdo, 'news-plugin')`, который:
- Проверяет авторизацию
- Определяет роль пользователя
- Проверяет права доступа
- Возвращает 403 при отказе

### 5. Фильтрация меню в сайдбаре

**Файл:** `/admin/template/sidebar.php`

Добавлена фильтрация меню плагинов через `filterPluginMenusByAccess()`.

## Формат хранения настроек

Настройки хранятся в JSON-поле `users.data` пользователя с `author='admin'`:

```json
{
  "plugins_access": {
    "news": {
      "user": true,
      "admin": true
    }
  }
}
```

## Структура ключей

- `plugins_access.{plugin_name}.{role}` = true/false

Это расширяемая структура для будущих плагинов.

## Поведение системы

### По умолчанию
Если настройки не заданы - доступ разрешён (безопасное поведение по умолчанию).

### При запрете доступа
1. Пользователь не видит пункты меню плагина в сайдбаре
2. При попытке прямого доступа по URL - получает HTTP 403 Forbidden
3. Событие логируется (если логирование включено)

### Уровни доступа
- Страницы плагина: доступ на основе роли
- Страница настроек: только `author='admin'`

## Примеры использования

### В плагинах

```php
// Подключить систему доступа
require_once __DIR__ . '/../../../../admin/functions/plugin_access.php';

// Защитить страницу (любая разрешённая роль)
$userDataAdmin = pluginAccessGuard($pdo, 'news-plugin');

// Защитить страницу (только admin)
$userDataAdmin = pluginAccessGuard($pdo, 'news-plugin', 'admin');
```

### Проверка доступа вручную

```php
$userRole = $userDataAdmin['author']; // 'user' или 'admin'
if (hasPluginAccess($pdo, 'news-plugin', $userRole)) {
    // Доступ разрешён
}
```

### Фильтрация меню

```php
$pluginMenus = getPluginMenus($pdo);
$filteredMenus = filterPluginMenusByAccess($pdo, $pluginMenus, $userRole);
```

## Тестовые сценарии

### Сценарий 1: Доступ разрешён для user
1. Войти под пользователем с `author='user'`
2. Зайти в настройки и включить доступ для user
3. Проверить: меню "Новости" видно
4. Проверить: страницы новостей открываются

### Сценарий 2: Доступ запрещён для user
1. Войти под администратором
2. Зайти в настройки и выключить доступ для user
3. Войти под пользователем с `author='user'`
4. Проверить: меню "Новости" скрыто
5. Попробовать открыть `/plugins/news-plugin/pages/articles/article_list.php`
6. Ожидаемый результат: HTTP 403 Forbidden

### Сценарий 3: Доступ разрешён для admin
1. Войти под администратором
2. Зайти в настройки и включить доступ для admin
3. Проверить: меню "Новости" видно
4. Проверить: все страницы новостей открываются

### Сценарий 4: Доступ запрещён для admin
1. Войти под администратором
2. Зайти в настройки и выключить доступ для admin
3. Проверить: меню "Новости" скрыто
4. Попробовать открыть любую страницу плагина
5. Ожидаемый результат: HTTP 403 Forbidden

### Сценарий 5: Доступ к странице настроек
1. Войти под пользователем с `author='user'`
2. Попробовать открыть `/plugins/news-plugin/pages/settings/access.php`
3. Ожидаемый результат: HTTP 403 Forbidden (требуется роль admin)
4. Войти под администратором
5. Открыть страницу настроек
6. Ожидаемый результат: страница открывается

## Безопасность

### CSRF-защита
Все формы защищены CSRF-токеном из сессии.

### SQL-инъекции
Все запросы используют prepared statements.

### HTTP-ответы
При отказе в доступе возвращается HTTP 403 Forbidden.

### Логирование
Все события доступа логируются (если включено):
- Успешные проверки (info)
- Отказы в доступе (info)
- Ошибки (error)

## Расширение на другие плагины

Для добавления контроля доступа к другому плагину:

1. В страницах плагина:
```php
require_once __DIR__ . '/path/to/admin/functions/plugin_access.php';
$userDataAdmin = pluginAccessGuard($pdo, 'plugin-name');
```

2. Создать страницу настроек (копировать `access.php`)

3. В `nav-config.json` плагина добавить пункт "Настройки"

4. В странице настроек изменить:
   - `pluginAccessGuard($pdo, 'plugin-name', 'admin')`
   - Ключи: `plugins_access.plugin-name.user`, `plugins_access.plugin-name.admin`

## Совместимость

- PHP 7.4+
- Работает с существующей системой авторизации
- Обратно совместимо (при отсутствии настроек - доступ разрешён)
- Не требует изменений в базе данных

## Производительность

- Минимальное влияние (1 запрос на чтение настроек при загрузке страницы)
- Настройки кешируются в переменных PHP
- Нет дополнительных запросов в цикле отрисовки меню

## Будущие улучшения

Потенциальные улучшения:
1. Кеширование настроек доступа в сессии
2. Поддержка пользовательских ролей (не только user/admin)
3. Детальный контроль доступа (по отдельным действиям: read, create, update, delete)
4. UI для массового управления доступом к нескольким плагинам
5. Экспорт/импорт настроек доступа

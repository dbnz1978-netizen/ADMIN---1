# Руководство по тестированию системы контроля доступа

## Подготовка к тестированию

### 1. Предварительные требования

- База данных должна быть настроена
- В БД должен быть пользователь с `author='admin'`
- В БД должен быть пользователь с `author='user'`
- Плагин "Новости" должен быть установлен и включён

### 2. Проверка установки

Убедитесь, что следующие файлы присутствуют:

```bash
# Основная система
/admin/functions/plugin_access.php

# Страница настроек
/plugins/news-plugin/pages/settings/access.php

# Обновлённое меню
/plugins/news-plugin/nav-config.json

# Обновлённые страницы (с guards)
/plugins/news-plugin/pages/articles/article_list.php
/plugins/news-plugin/pages/articles/add_article.php
/plugins/news-plugin/pages/articles/add_extra.php
/plugins/news-plugin/pages/articles/extra_list.php
/plugins/news-plugin/pages/categories/category_list.php
/plugins/news-plugin/pages/categories/add_category.php
```

## Тестовые сценарии

### Тест 1: Первоначальная настройка (оба доступа включены)

**Цель:** Проверить поведение по умолчанию

**Шаги:**
1. Войти под администратором (author='admin')
2. Открыть `/plugins/news-plugin/pages/settings/access.php`
3. Убедиться, что оба переключателя включены (по умолчанию)
4. Сохранить настройки
5. Проверить, что меню "Новости" видно в сайдбаре
6. Открыть любую страницу новостей - должна открыться успешно

**Ожидаемый результат:**
- ✓ Меню "Новости" видно
- ✓ Все страницы доступны
- ✓ Настройки сохранены

---

### Тест 2: Отключение доступа для user

**Цель:** Проверить, что пользователи с author='user' теряют доступ

**Шаги:**
1. Войти под администратором
2. Открыть `/plugins/news-plugin/pages/settings/access.php`
3. Выключить переключатель "Разрешить доступ пользователям (роль: user)"
4. Оставить включённым "Разрешить доступ администраторам (роль: admin)"
5. Сохранить настройки
6. Выйти из системы
7. Войти под пользователем с author='user'
8. Проверить сайдбар
9. Попробовать открыть напрямую `/plugins/news-plugin/pages/articles/article_list.php`

**Ожидаемый результат:**
- ✓ Меню "Новости" НЕ видно в сайдбаре
- ✓ При прямом открытии URL: HTTP 403 Forbidden
- ✓ Сообщение: "Доступ запрещён: у вас нет прав для доступа к этому разделу"

---

### Тест 3: Отключение доступа для admin

**Цель:** Проверить, что даже администраторы могут быть ограничены

**Шаги:**
1. Войти под администратором
2. Открыть `/plugins/news-plugin/pages/settings/access.php`
3. Выключить переключатель "Разрешить доступ администраторам (роль: admin)"
4. Оставить включённым или выключить "user" (не важно)
5. Сохранить настройки
6. Обновить страницу или перейти на главную
7. Проверить сайдбар
8. Попробовать открыть напрямую `/plugins/news-plugin/pages/articles/article_list.php`

**Ожидаемый результат:**
- ✓ Меню "Новости" НЕ видно в сайдбаре
- ✓ При прямом открытии URL: HTTP 403 Forbidden
- ⚠️ Страница настроек `/plugins/news-plugin/pages/settings/access.php` ОСТАЁТСЯ доступной (это правильно, иначе admin не сможет вернуть доступ)

---

### Тест 4: Доступ к странице настроек

**Цель:** Убедиться, что только admin может изменять настройки

**Шаги:**
1. Войти под пользователем с author='user'
2. Попробовать открыть `/plugins/news-plugin/pages/settings/access.php`

**Ожидаемый результат:**
- ✓ HTTP 403 Forbidden
- ✓ Сообщение: "Доступ запрещён: недостаточно прав"

---

### Тест 5: Восстановление доступа

**Цель:** Проверить, что доступ можно вернуть

**Шаги:**
1. Войти под администратором
2. Открыть `/plugins/news-plugin/pages/settings/access.php`
3. Включить оба переключателя
4. Сохранить настройки
5. Проверить, что меню "Новости" появилось
6. Открыть любую страницу новостей

**Ожидаемый результат:**
- ✓ Меню "Новости" видно
- ✓ Все страницы доступны

---

### Тест 6: Проверка CSRF-защиты

**Цель:** Убедиться, что настройки нельзя изменить без CSRF-токена

**Шаги:**
1. Войти под администратором
2. Открыть DevTools браузера → Network
3. Открыть `/plugins/news-plugin/pages/settings/access.php`
4. Отправить POST-запрос с помощью curl или Postman БЕЗ CSRF-токена:

```bash
curl -X POST http://your-domain/plugins/news-plugin/pages/settings/access.php \
  -d "allow_user=on&allow_admin=on" \
  -b "PHPSESSID=your_session_id"
```

**Ожидаемый результат:**
- ✓ Ошибка: "Ошибка проверки безопасности. Попробуйте снова."
- ✓ Настройки НЕ изменены

---

### Тест 7: Проверка логирования

**Цель:** Убедиться, что события доступа логируются

**Шаги:**
1. Включить логирование в настройках администратора
2. Войти под пользователем с author='user' при отключённом доступе
3. Попробовать открыть страницу новостей
4. Проверить лог-файлы

**Ожидаемый результат:**
- ✓ В логах есть запись: "Отказ в доступе к плагину 'news': пользователь ID=... (роль=user)"

---

## Проверочный список перед релизом

- [ ] Все PHP файлы не содержат синтаксических ошибок
- [ ] nav-config.json валиден
- [ ] Страница настроек открывается для admin
- [ ] Страница настроек закрыта для user
- [ ] Меню фильтруется корректно
- [ ] HTTP 403 возвращается при отказе
- [ ] CSRF-защита работает
- [ ] Настройки сохраняются в users.data
- [ ] Логирование работает (если включено)
- [ ] Доступ можно включить/выключить для каждой роли независимо

## Отладка

### Проверка настроек в БД

```sql
SELECT id, author, data 
FROM users 
WHERE author = 'admin' 
LIMIT 1;
```

Должно быть примерно так:
```json
{
  "plugins_access": {
    "news": {
      "user": true,
      "admin": true
    }
  }
}
```

### Проверка логов

Если логирование включено, проверьте файл логов на наличие записей:
- "Настройки доступа к плагину 'news' обновлены"
- "Отказ в доступе к плагину 'news'"

### Общие проблемы

**Проблема:** Меню не фильтруется
**Решение:** Проверьте, что в sidebar.php подключён plugin_access.php и вызывается filterPluginMenusByAccess()

**Проблема:** HTTP 403 не возвращается
**Решение:** Проверьте, что на странице вызывается pluginAccessGuard()

**Проблема:** Настройки не сохраняются
**Решение:** Проверьте права записи в БД и формат JSON в users.data

## Быстрый тест (для CI/CD)

Создайте простой скрипт для автоматизированного тестирования:

```bash
#!/bin/bash

echo "Проверка синтаксиса PHP..."
find admin/functions plugins/news-plugin -name "*.php" -exec php -l {} \; || exit 1

echo "Проверка JSON..."
cat plugins/news-plugin/nav-config.json | python3 -m json.tool > /dev/null || exit 1

echo "✓ Все проверки пройдены"
```

## Контакты для поддержки

При обнаружении проблем:
1. Проверьте логи ошибок PHP
2. Проверьте логи приложения (если включено)
3. Убедитесь, что БД содержит корректные данные
4. Проверьте версию PHP (требуется 7.4+)

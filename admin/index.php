<?php

/**
 * Название файла:      index.php
 * Назначение:          Админ-панель — Главная точка входа (административный роутер)
 *                      - Единая точка входа для всех администраторов и модераторов
 *                      - Выполняет предварительную инициализацию: подключение БД, проверка целостности
 *                        настроек администратора, проверка сессии, управление логированием, безопасное перенаправление
 *                      - НЕ отображает контент напрямую — только перенаправляет:
 *                        • на logout.php — при отсутствии авторизации или критических ошибках
 *                        • на user/index.php — при успешной авторизации
 * Автор:               Команда разработки
 * Версия:              1.0
 * Дата создания:       2026-02-10
 * Последнее изменение: 2026-02-10
 */

// ========================================
// КОНФИГУРАЦИЯ
// ========================================

$config = [
    'display_errors' => false,  // включение отображения ошибок true/false
    'set_encoding'   => true,   // включение кодировки UTF-8
    'db_connect'     => true,   // подключение к базе
    'auth_check'     => true,   // подключение функций авторизации
    'file_log'       => true,   // подключение системы логирования
];

// Подключаем центральную инициализацию
require_once __DIR__ . '/functions/init.php';


// ========================================
// ПОЛУЧЕНИЕ НАСТРОЕК АДМИНИСТРАТОРА
// ========================================

// Получаем настройки администратора из БД
$adminData = getAdminData($pdo);

if ($adminData === false) {
    // Критическая ошибка: запись админа повреждена или отсутствует → безопасный выход
    header("Location: logout.php");
    exit;
}

// ========================================
// НАСТРОЙКА ЛОГИРОВАНИЯ
// ========================================

// Включаем/отключаем логирование. Глобальные константы.
define('LOG_INFO_ENABLED', ($adminData['log_info_enabled'] ?? false) === true);    // Логировать информационные события
define('LOG_ERROR_ENABLED', ($adminData['log_error_enabled'] ?? false) === true);  // Логировать ошибки и предупреждения

// ========================================
// ПРОВЕРКА АВТОРИЗАЦИИ
// ========================================

// Проверяем, авторизован ли текущий пользователь
$user = redirectIfAuth($pdo);  // Возвращает массив с данными или false

if ($user) {
    // Пользователь авторизован → перенаправляем в личный кабинет
    $redirectTo = 'user/index.php';
    $logMessage = "Авторизованный пользователь перенаправлен на: $redirectTo — ID: {$user['id']} — IP: "
        . "{$_SERVER['REMOTE_ADDR']}";
    logEvent($logMessage, LOG_INFO_ENABLED, 'info');
    header("Location: $redirectTo");
    exit;
}

// ========================================
// ПЕРЕНАПРАВЛЕНИЕ НЕАВТОРИЗОВАННОГО ПОЛЬЗОВАТЕЛЯ
// ========================================

// Пользователь не авторизован → отправляем на выход (logout.php обрабатывает сессию и показывает форму входа)
header("Location: logout.php");
exit;